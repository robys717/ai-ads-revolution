<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Ads Revolution ‚Äî Dashboard</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icone -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700,800&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Stili locali -->
  <link rel="stylesheet" href="/public/dashboard/dashboard.css">
  <style>html{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}</style>
</head>
<body class="bg-slate-950 text-slate-100">
  <!-- Topbar -->
  <header class="fixed inset-x-0 top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-cyan-400 to-blue-600 shadow-lg"></div>
        <span class="text-lg font-semibold">AI Ads Revolution</span>
        <span id="envBadge" class="ml-2 text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700">LIVE</span>
      </div>
      <nav class="flex items-center gap-2">
        <button id="btnGoSite" class="text-sm px-3 py-2 rounded hover:bg-slate-800">Sito</button>
        <button id="btnTheme" class="text-sm px-3 py-2 rounded hover:bg-slate-800">Tema</button>
        <div class="h-8 w-px bg-slate-800 mx-2"></div>
        <div id="userBox" class="flex items-center gap-3">
          <span id="userName" class="text-sm text-slate-300">Ospite</span>
          <button id="btnAuth" class="px-3 py-2 text-sm rounded bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold">Accedi</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Layout -->
  <div class="pt-16 max-w-7xl mx-auto px-4">
    <div class="grid grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside class="col-span-12 lg:col-span-3">
        <div class="sticky top-20 space-y-2">
          <a href="#" data-view="home" class="navlink active">üè†  Panoramica</a>
          <a href="#" data-view="campaigns" class="navlink">üì¢  Campagne</a>
          <a href="#" data-view="wallet" class="navlink">üí≥  Wallet</a>
          <a href="#" data-view="analytics" class="navlink">üìà  Analytics</a>
          <a href="#" data-view="assets" class="navlink">üóÇÔ∏è  Asset</a>
          <a href="#" data-view="settings" class="navlink">‚öôÔ∏è  Impostazioni</a>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-span-12 lg:col-span-9 space-y-6">
        <!-- KPIs -->
        <section id="cards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="card"><p class="label">Budget Totale</p><p id="kpiBudget" class="value">‚Äî</p></div>
          <div class="card"><p class="label">Spesa Oggi</p><p id="kpiSpent" class="value">‚Äî</p></div>
          <div class="card"><p class="label">CPC Medio</p><p id="kpiCpc" class="value">‚Äî</p></div>
          <div class="card"><p class="label">CTR</p><p id="kpiCtr" class="value">‚Äî</p></div>
        </section>

        <!-- Grafici -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="panel">
            <div class="panel-title">Clic & Visualizzazioni (7gg)</div>
            <canvas id="chartClicks"></canvas>
          </div>
          <div class="panel">
            <div class="panel-title">Spesa Giornaliera (7gg)</div>
            <canvas id="chartSpend"></canvas>
          </div>
        </section>

        <!-- Tabella campagne -->
        <section class="panel">
          <div class="flex items-center justify-between">
            <div class="panel-title">Le tue campagne</div>
            <button id="btnNewCampaign" class="btn-primary">+ Nuova campagna</button>
          </div>
          <div class="mt-3">
            <input id="campaignSearch" placeholder="Cerca per titolo, interessi..." class="input w-full">
          </div>
          <div class="mt-4 overflow-x-auto">
            <table class="table">
              <thead>
                <tr><th>Titolo</th><th>Stato</th><th>Budget</th><th>CPC</th><th>CPV</th><th>Aggiornata</th><th></th></tr>
              </thead>
              <tbody id="campaignsRows">
                <tr><td colspan="7" class="text-center text-slate-400 py-8">Nessuna campagna</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal auth -->
  <dialog id="dlgAuth" class="modal">
    <form method="dialog" class="modal-box">
      <h3 class="mb-4 text-lg font-semibold">Accedi o Registrati</h3>
      <div class="space-y-3">
        <input id="authName" class="input w-full" placeholder="Nome (per registrazione)">
        <input id="authEmail" class="input w-full" placeholder="Email">
        <input id="authPass" type="password" class="input w-full" placeholder="Password">
      </div>
      <div class="flex gap-2 justify-end mt-4">
        <button class="btn" value="cancel">Annulla</button>
        <button id="btnLogin" class="btn-primary" value="default">Accedi</button>
        <button id="btnRegister" class="btn-secondary" value="default">Registrati</button>
      </div>
    </form>
  </dialog>

  <!-- Modal nuova campagna -->
  <dialog id="dlgCampaign" class="modal">
    <form method="dialog" class="modal-box">
      <h3 class="mb-4 text-lg font-semibold">Nuova Campagna</h3>
      <div class="grid grid-cols-2 gap-3">
        <input id="fTitle" class="input col-span-2" placeholder="Titolo">
        <textarea id="fDesc" class="input col-span-2" placeholder="Descrizione"></textarea>
        <input id="fURL" class="input col-span-2" placeholder="URL destinazione (https://)">
        <input id="fBudget" class="input" placeholder="Budget ‚Ç¨ (es. 50)">
        <input id="fCpc" class="input" placeholder="CPC ‚Ç¨ (es. 0.15)">
        <input id="fCpv" class="input" placeholder="CPV ‚Ç¨ (es. 0.001)">
        <input id="fLocation" class="input" placeholder="Localit√† (es. Italia)">
        <input id="fInterests" class="input col-span-2" placeholder="Interessi (virgole)">
      </div>
      <div class="flex gap-2 justify-end mt-4">
        <button class="btn" value="cancel">Annulla</button>
        <button id="btnCreateCampaign" class="btn-primary" value="default">Crea</button>
      </div>
    </form>
  </dialog>

  <script>
    const BASE = '';
    const $ = sel => document.querySelector(sel);
    const token = () => localStorage.getItem('token') || '';
    const headers = () => token() ? { 'Authorization':'Bearer '+token(),'Content-Type':'application/json'} : { 'Content-Type':'application/json' };

    // nav attiva
    document.querySelectorAll('.navlink').forEach(a=>{
      a.addEventListener('click',e=>{
        e.preventDefault();
        document.querySelectorAll('.navlink').forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
      });
    });

    // tema
    $('#btnTheme').onclick = ()=> document.documentElement.classList.toggle('light');

    // sito
    $('#btnGoSite').onclick = ()=> location.href = '/site/';

    // auth
    const dlgAuth = $('#dlgAuth');
    $('#btnAuth').onclick = ()=> dlgAuth.showModal();
    $('#btnLogin').onclick = async (e)=>{
      e.preventDefault();
      const email = $('#authEmail').value.trim();
      const password = $('#authPass').value;
      const r = await fetch('/auth/login',{method:'POST',headers: {'Content-Type':'application/json'},body:JSON.stringify({email,password})});
      const j = await r.json();
      if(j.token){ localStorage.setItem('token', j.token); dlgAuth.close(); afterLogin(); } else alert(j.error||'Errore login');
    };
    $('#btnRegister').onclick = async (e)=>{
      e.preventDefault();
      const name = $('#authName').value.trim();
      const email = $('#authEmail').value.trim();
      const password = $('#authPass').value;
      const r = await fetch('/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,password})});
      const j = await r.json();
      if(j.token){ localStorage.setItem('token', j.token); dlgAuth.close(); afterLogin(); } else alert(j.error||'Errore registrazione');
    };

    // carica dati dashboard
    async function loadCampaigns(){
      const q = $('#campaignSearch').value.toLowerCase();
      const r = await fetch('/campaigns',{ headers: headers() });
      if(!r.ok){ $('#campaignsRows').innerHTML = '<tr><td colspan="7" class="py-8 text-center text-slate-400">Accedi per vedere le campagne</td></tr>'; return; }
      const rows = await r.json();
      const fmt = n => (n/100).toLocaleString('it-IT',{style:'currency',currency:(new URLSearchParams(location.search).get('currency')||'EUR')});
      const html = rows
        .filter(c => !q || (c.title||'').toLowerCase().includes(q) || (c.interests||'').toLowerCase().includes(q))
        .map(c=>`
          <tr>
            <td class="font-medium">${c.title||''}</td>
            <td>${c.active?'<span class="pill green">ATTIVA</span>':'<span class="pill gray">PAUSA</span>'}</td>
            <td>${fmt(c.budget_cents||0)}</td>
            <td>${fmt(c.cpc_cents||0)}</td>
            <td>‚Ç¨ ${(c.cpv_micros||0/100000).toFixed(4)}</td>
            <td>${(c.updated_at||c.created_at||'').replace('T',' ').slice(0,19)}</td>
            <td><a class="link" href="/click?campaign_id=${c.id}" target="_blank">Test Click</a></td>
          </tr>`).join('');
      $('#campaignsRows').innerHTML = html || '<tr><td colspan="7" class="py-8 text-center text-slate-400">Nessuna campagna</td></tr>';
      // KPI (semplici)
      const totalBudget = rows.reduce((a,b)=>a+(b.budget_cents||0),0);
      $('#kpiBudget').textContent = fmt(totalBudget);
      $('#kpiSpent').textContent = '‚Ç¨ 0,00'; // segnaposto (integrazione spese giorno in /interactions)
      $('#kpiCpc').textContent = rows.length? fmt(Math.round(rows.reduce((a,b)=>a+(b.cpc_cents||0),0)/rows.length)) : '‚Äî';
      $('#kpiCtr').textContent = '‚Äî';
    }

    // crea campagna
    const dlgCampaign = $('#dlgCampaign');
    $('#btnNewCampaign').onclick = ()=> {
      if(!token()){ dlgAuth.showModal(); return; }
      dlgCampaign.showModal();
    };
    $('#btnCreateCampaign').onclick = async (e)=>{
      e.preventDefault();
      const body = {
        title: $('#fTitle').value,
        description: $('#fDesc').value,
        destination_url: $('#fURL').value,
        budget_eur: parseFloat($('#fBudget').value||'0')||0,
        cpc_eur: parseFloat($('#fCpc').value||'0.1')||0.1,
        cpv_eur: parseFloat($('#fCpv').value||'0.001')||0.001,
        location: $('#fLocation').value,
        interests: $('#fInterests').value
      };
      const r = await fetch('/campaigns',{method:'POST',headers: headers(), body: JSON.stringify(body)});
      const j = await r.json();
      if(j.id){ dlgCampaign.close(); await loadCampaigns(); alert('Campagna creata!'); }
      else alert(j.error||'Errore creazione');
    };

    // ricerca
    $('#campaignSearch').addEventListener('input', loadCampaigns);

    // charts (mock iniziale)
    function buildCharts(){
      const labels = Array.from({length:7},(_,i)=>['Dom','Lun','Mar','Mer','Gio','Ven','Sab'][i]);
      new Chart(document.getElementById('chartClicks'),{
        type:'line',
        data:{ labels, datasets:[
          { label:'Click', data:[12,19,8,14,11,16,9], tension:.35 },
          { label:'Views (x100)', data:[120,180,160,200,190,220,170], tension:.35 }
        ]},
        options:{ responsive:true, plugins:{legend:{labels:{color:'#cbd5e1'}}}, scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}
      });
      new Chart(document.getElementById('chartSpend'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Spesa ‚Ç¨', data:[4.2,6.1,3.5,5.0,4.4,6.8,3.9]}]},
        options:{ responsive:true, plugins:{legend:{labels:{color:'#cbd5e1'}}}, scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}
      });
    }

    function afterLogin(){
      const payload = parseJwt(token());
      $('#userName').textContent = payload?.name || 'Utente';
      $('#btnAuth').textContent = 'Logout';
      $('#btnAuth').onclick = ()=>{ localStorage.removeItem('token'); location.reload(); };
      loadCampaigns();
    }

    function parseJwt(t){
      try{ return JSON.parse(atob(t.split('.')[1])); }catch(_){ return null; }
    }

    // init
    buildCharts();
    if(token()) afterLogin(); else loadCampaigns();
  </script>
</body>
</html>
